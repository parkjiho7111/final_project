<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sseuk-Sseuk : ì§€ì—­ ì†Œì‹</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

    <style>
        /* [1] ì§€ë„ ì»¨í…Œì´ë„ˆ ë° SVG ë°˜ì‘í˜• ì„¤ì • */
        #svg-container {
            perspective: 1000px;
            overflow: visible;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #svg-container svg {
            width: 100% !important;
            height: auto !important;
            max-height: 60vh !important;
            /* ëª¨ë°”ì¼ ê¸°ë³¸: í—¤ë” ê³µê°„ í™•ë³´ë¥¼ ìœ„í•´ ì¶•ì†Œ */
            max-width: 100% !important;
            display: block;
            transform-origin: center center;
            overflow: visible;
        }

        @media (min-width: 768px) {
            #svg-container svg {
                max-height: 70vh !important;
                /* ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” ì¡°ê¸ˆ ë” í¬ê²Œ */
            }
        }

        /* [2] í¼ì¦ ì¡°ê° ìŠ¤íƒ€ì¼ */
        .puzzle-piece {
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* [NEW] ì§€ë„ ìˆ¨ì‰¬ëŠ” íš¨ê³¼ (Alive Effect) */
        @keyframes breathe {

            0%,
            100% {
                filter: drop-shadow(0px 4px 0px #4A9EA8) brightness(1);
                transform: translateZ(0);
            }

            50% {
                filter: drop-shadow(0px 6px 2px #4A9EA8) brightness(1.05);
                transform: translateZ(5px);
            }
        }

        .region-alive {
            animation: breathe 3s ease-in-out infinite;
        }

        g.puzzle-piece path,
        path.puzzle-piece {
            fill: #ffffff;
            stroke: #4A9EA8;
            stroke-width: 1px;
            filter: drop-shadow(0px 4px 0px #4A9EA8) drop-shadow(0px 5px 5px rgba(0, 0, 0, 0.1));
            transition: all 0.4s ease;
        }

        .puzzle-piece:hover {
            transform: translateZ(20px) translateY(-15px);
            z-index: 50;
        }

        .puzzle-piece:hover path,
        path.puzzle-piece:hover {
            filter: drop-shadow(0px 15px 0px #4A9EA8) drop-shadow(0px 25px 30px rgba(74, 158, 168, 0.4));
        }

        /* [3] ë¹„í™œì„± ì˜ì—­ */
        .region-disabled {
            pointer-events: none;
            opacity: 0.5;
        }

        .region-disabled path,
        path.region-disabled {
            fill: #eeeeee;
            stroke: #dddddd;
            filter: none;
        }

        /* [4] UI ìš”ì†Œ */
        #info-tooltip {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 100;
            display: none;
            align-items: center;
        }

        .tooltip-line {
            height: 1px;
            background-color: #4A9EA8;
            box-shadow: 0 0 5px #4A9EA8;
        }

        .tooltip-content {
            display: flex;
            flex-direction: column;
            opacity: 0;
        }

        .tooltip-badge {
            font-size: 10px;
            background-color: #E0BA76;
            color: white;
            padding: 2px 6px;
            border-radius: 9999px;
            margin-bottom: 4px;
            font-weight: bold;
            width: fit-content;
        }

        .tooltip-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #374151;
            line-height: 1;
            margin-bottom: 4px;
        }

        .tooltip-count {
            font-size: 1rem;
            color: #6B7280;
            font-weight: 500;
        }

        .tooltip-count span {
            color: #4A9EA8;
            font-weight: 700;
        }

        /* [NEW] CTA ë²„íŠ¼ í„ìŠ¤ íš¨ê³¼ */
        @keyframes subtle-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(74, 158, 168, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(74, 158, 168, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(74, 158, 168, 0);
            }
        }

        .animate-subtle-pulse {
            animation: subtle-pulse 2s infinite;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (auth-input ë“± ê³µí†µ ìŠ¤íƒ€ì¼ì€ auth_modal.html CSSì™€ ê³µìœ ë¨) */
        .auth-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            outline: none;
            transition: all 0.2s ease;
            font-size: 1rem;
        }

        .auth-input:focus {
            background-color: #fff;
            border-color: #4A9EA8;
            box-shadow: 0 0 0 4px rgba(74, 158, 168, 0.1);
        }

        #transition-overlay {
            position: fixed;
            inset: 0;
            background-color: white;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
        }

        /* ë°°ê²½ */
        body {
            background-color: #f9fafb;
            background-image: radial-gradient(#4A9EA8 1.5px, transparent 1.5px), radial-gradient(#F48245 1.5px, transparent 1.5px), radial-gradient(#D9B36C 1.5px, transparent 1.5px);
            background-size: 75px 75px;
            background-position: 0 0, 25px 25px, 50px 50px;
            animation: particleMove 60s linear infinite;
        }

        @keyframes particleMove {
            0% {
                background-position: 0 0, 25px 25px, 50px 50px;
            }

            100% {
                background-position: 750px 0, 775px 25px, 800px 50px;
            }
        }

        /* [MOBILE UX START] ëª¨ë°”ì¼ ë°”í…€ ì‹œíŠ¸ ìŠ¤íƒ€ì¼ */
        #mobile-bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(110%);
            /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 1000;
            padding: 24px 20px 40px 20px;
            /* í•˜ë‹¨ ì—¬ë°± ë„‰ë„‰íˆ */
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        #mobile-bottom-sheet.active {
            transform: translateY(0);
        }

        /* ì§€ë„ê°€ ì‹œíŠ¸ì— ê°€ë ¤ì§€ì§€ ì•Šê²Œ ë°€ì–´ì˜¬ë¦¬ëŠ” íš¨ê³¼ */
        .map-shifted {
            transition: transform 0.3s ease;
            transform: translateY(-20vh) !important;
            /* ì§€ë„ ì „ì²´ë¥¼ ìœ„ë¡œ 20% ì´ë™ */
        }

        /* [MOBILE UX] í—¤ë” ìˆ¨ê¹€ ì²˜ë¦¬ (ì§€ë„ì™€ ê²¹ì¹¨ ë°©ì§€) */
        #intro-header {
            transition: all 0.5s ease;
        }

        #intro-header.header-hidden {
            opacity: 0;
            transform: translateY(-50px);
            pointer-events: none;
        }

        /* [MOBILE UX END] */
    </style>
</head>

<body class="text-gray-900 overflow-hidden h-screen flex flex-col relative font-sans py-4 md:py-8">
    <div id="transition-overlay"></div>
    <div id="intro-gate"
        class="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-gray-50/90 backdrop-blur-md transition-all duration-700 hidden">
        <div class="text-center space-y-8 opacity-0 translate-y-10" id="intro-content">
            <div class="space-y-2">
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 tracking-tight break-keep">ë‹¹ì‹ ì˜ <span
                        class="text-[#4A9EA8]">ì§€ì—­</span>ì„<br>íƒìƒ‰í•´ë³´ì„¸ìš”</h1>
                <p class="text-gray-500 text-lg">ë‚´ê°€ ì‚¬ëŠ” ê³³ì˜ ì²­ë…„ ì •ì±…ì„ ê°€ì¥ ì‰½ê³  ë¹ ë¥´ê²Œ.</p>
            </div>
            <div class="flex flex-col gap-3 w-full max-w-xs mx-auto">
                <button id="btn-start"
                    class="w-full py-4 bg-[#4A9EA8] hover:bg-[#3b858e] text-white font-bold rounded-xl shadow-lg shadow-teal-500/30 transition-all hover:-translate-y-1 text-lg flex items-center justify-center gap-2 animate-subtle-pulse">
                    <span>ì§€ë„ì—ì„œ ì§€ì—­ ì°¾ê¸°</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </button>
            </div>
            <div class="pt-4 border-t border-gray-200 w-full max-w-xs mx-auto">
                <p class="text-sm text-gray-500 mb-2">ì´ë¯¸ ë‚˜ë§Œì˜ êµ¬ì—­ì´ ìˆìœ¼ì‹ ê°€ìš”?</p>
                <button id="btn-intro-login" class="text-[#4A9EA8] font-bold hover:underline text-base js-login-trigger"
                    data-mode="login">ê¸°ì¡´ íšŒì› ë¡œê·¸ì¸ &rarr;</button>
            </div>
        </div>
    </div>

    {% with btn_class="bg-[#4A9EA8] hover:bg-[#3b858e]" %}
    {% include "components/auth_modal.html" %}
    {% endwith %}

    <div id="back-nav" class="fixed top-6 left-6 z-50 hidden">
        <button onclick="window.location.href='/'"
            class="flex items-center gap-2 px-4 py-2 bg-white/90 backdrop-blur rounded-full shadow-lg border border-gray-100 hover:bg-[#4A9EA8] hover:text-white transition-all group cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 transition-transform group-hover:-translate-x-1"
                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span class="font-bold text-sm">ì „êµ­ì§€ë„ ë³´ê¸°</span>
        </button>
    </div>

    <!-- [NEW] ë¡œê·¸ì¸ ìƒíƒœ í‘œì‹œ (ìš°ì¸¡ ìƒë‹¨) - ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ ì¶”ê°€ -->
    <div id="user-status" class="fixed bottom-6 right-6 z-50 hidden pointer-events-auto group">
        <div
            class="bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-lg border border-gray-100 flex items-center gap-2 transition-all hover:pr-3 cursor-default">
            <div class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></div>
            <span id="user-name-display" class="font-bold text-gray-700 text-sm"></span>

            <!-- [UX ê°œì„ ] í…ìŠ¤íŠ¸ ëŒ€ì‹  ì•„ì´ì½˜ìœ¼ë¡œ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í‘œì‹œ -->
            <button id="btn-landing-logout"
                class="ml-2 w-6 h-6 flex items-center justify-center rounded-full text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors"
                title="ë¡œê·¸ì•„ì›ƒ">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
            </button>
        </div>
    </div>

    <div id="info-tooltip">
        <div class="tooltip-line"></div>
        <div class="tooltip-content"><span class="tooltip-badge">Region</span>
            <h3 class="tooltip-title">ì§€ì—­ëª…</h3>
            <p class="tooltip-count">ì •ì±… ìˆ˜ : <span>0</span></p>
        </div>
    </div>



    <div id="main-content"
        class="relative w-full h-full flex flex-col items-center justify-center opacity-0 hidden p-4">
        <header id="intro-header" class="text-center z-10 flex-none mb-6 md:mb-10 pointer-events-none px-4">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 leading-tight mb-2 break-keep"
                id="header-title">ì“±-ì“± í›‘ì–´
                ë³´ëŠ”<br>ì²­ë…„ ì •ì±… ì†Œì‹</h1>
            <p class="text-gray-500 text-lg leading-relaxed break-keep" id="header-desc">ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì§€ì—­ë³„ ë‰´ìŠ¤ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        </header>
        <main id="svg-container" class="w-full max-w-5xl flex items-center justify-center flex-1"></main>
    </div>

    <script src="/static/script.js"></script>

    <script>
        // ê¸°ë³¸ ì„¤ì • ë°ì´í„° (API ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì´ ê°’ì´ ë³´ì„)
        const REGION_DATA = {
            'national': { mapPath: '/static/images/map.svg', title: 'ì „êµ­ ì†Œì‹', desc: 'ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì§€ì—­ë³„ ë‰´ìŠ¤ë¥¼ í™•ì¸í•˜ì„¸ìš”', db: { 'metropolitan': { name: 'ì„œìš¸/ê²½ê¸°/ì¸ì²œ', count: 4250 }, 'chungnam': { name: 'ì¶©ë‚¨/ëŒ€ì „/ì„¸ì¢…', count: 589 }, 'jeonnam': { name: 'ì „ë‚¨/ê´‘ì£¼', count: 340 }, 'gyeongbug': { name: 'ê²½ë¶/ëŒ€êµ¬', count: 781 }, 'gyeongnam': { name: 'ê²½ë‚¨/ë¶€ì‚°/ìš¸ì‚°', count: 890 }, 'gangwon': { name: 'ê°•ì›ë„', count: 231 }, 'chungbug': { name: 'ì¶©ì²­ë¶ë„', count: 412 }, 'jeonbug': { name: 'ì „ë¼ë¶ë„', count: 620 }, 'jeju': { name: 'ì œì£¼íŠ¹ë³„ìì¹˜ë„', count: 156 } }, leftSideIds: ['metropolitan', 'chungnam', 'jeonbug', 'jeonnam', 'jeju'] },
            'metropolitan': { mapPath: '/static/images/total_metropolitan.svg', title: 'ìˆ˜ë„ê¶Œ ìƒì„¸', desc: 'ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”', db: { 'detail_seoul': { name: 'ì„œìš¸íŠ¹ë³„ì‹œ', count: 1200 }, 'detail_incheon': { name: 'ì¸ì²œê´‘ì—­ì‹œ', count: 450 }, 'detail_gyeonggi': { name: 'ê²½ê¸°ë„', count: 2100 } } },
            'chungnam': { mapPath: '/static/images/total_chungnam.svg', title: 'ì¶©ë‚¨/ëŒ€ì „/ì„¸ì¢… ìƒì„¸', desc: 'ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”', db: { 'detail_daejun': { name: 'ëŒ€ì „ê´‘ì—­ì‹œ', count: 320 }, 'detail_saejong': { name: 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ', count: 150 }, 'detail_chungnam': { name: 'ì¶©ì²­ë‚¨ë„', count: 480 } } },
            'jeonnam': { mapPath: '/static/images/total_jeonnam.svg', title: 'ì „ë‚¨/ê´‘ì£¼ ìƒì„¸', desc: 'ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”', db: { 'detail_gwangju': { name: 'ê´‘ì£¼ê´‘ì—­ì‹œ', count: 290 }, 'detail_jeonnam': { name: 'ì „ë¼ë‚¨ë„', count: 310 } } },
            'gyeongbug': { mapPath: '/static/images/total_gyeongbug.svg', title: 'ê²½ë¶/ëŒ€êµ¬ ìƒì„¸', desc: 'ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”', db: { 'detail_daegu': { name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ', count: 410 }, 'detail_gyeongbug': { name: 'ê²½ìƒë¶ë„', count: 520 } } },
            'gyeongnam': { mapPath: '/static/images/total_gyeongnam.svg', title: 'ê²½ë‚¨/ë¶€ì‚°/ìš¸ì‚°', desc: 'ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”', db: { 'detail_busan': { name: 'ë¶€ì‚°ê´‘ì—­ì‹œ', count: 680 }, 'detail_ulsan': { name: 'ìš¸ì‚°ê´‘ì—­ì‹œ', count: 210 }, 'detail_gyeongnam': { name: 'ê²½ìƒë‚¨ë„', count: 550 } } }
        };

        const urlParams = new URLSearchParams(window.location.search);
        const currentRegionKey = urlParams.get('region') || 'national';
        const currentConfig = REGION_DATA[currentRegionKey] || REGION_DATA['national'];
        const isDetailMode = currentRegionKey !== 'national';
        let isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';

        // [1] ì§€ë„ ì´ë²¤íŠ¸ ì´ˆê¸°í™” í•¨ìˆ˜ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
        function initMapEvents() {
            // [NEW] íˆ´íŒ ì„¤ì •ê°’ (ì‚¬ìš©ì ì»¤ìŠ¤í„°ë§ˆì´ì§• ì˜ì—­)
            const TOOLTIP_CONFIG = {
                LINE_MARGIN_X: 10,        // ì¢Œìš° ì—¬ë°± (px)

                // [!] ì—¬ê¸°ê°€ 'ì œì£¼ë„' ë“± í•˜ë‹¨ íˆ´íŒì˜ ë†’ì´(ì§€ë„ì™€ì˜ ê°„ê²©)ë¥¼ ì¡°ì ˆí•˜ëŠ” ê³³ì…ë‹ˆë‹¤!
                BOTTOM_ELEVATION_Y: -20,   // ìˆ˜ì¹˜ê°€ í´ìˆ˜ë¡ ë” ë†’ì´ ëœ¹ë‹ˆë‹¤.

                OFFSET_TOP_FACTOR: 0.3,   // ìƒë‹¨ ë°°ì¹˜ ì‹œ ìš”ì†Œ ë†’ì´ì˜ ëª‡% ì§€ì ì— ë§ì¶œì§€ (0.3 = 30%)
                BOTTOM_THRESHOLD: 0.75,   // í™”ë©´ í•˜ë‹¨ ëª‡% ì§€ì ë¶€í„° ìœ„ë¡œ ë„ìš¸ì§€ (0.75 = 75%)
                LINE_LENGTH_DEFAULT: 80,  // ê¸°ë³¸ ì—°ê²°ì„  ê¸¸ì´
                LINE_LENGTH_BOTTOM: 50    // í•˜ë‹¨ ì—°ê²°ì„  ê¸¸ì´
            };

            const svgElement = document.querySelector('#svg-container svg');
            if (!svgElement) return;
            svgElement.removeAttribute('width'); svgElement.removeAttribute('height');
            const tooltip = document.querySelector('#info-tooltip');
            const tTitle = tooltip.querySelector('.tooltip-title');
            const tCountSpan = tooltip.querySelector('.tooltip-count span');
            const overlay = document.getElementById('transition-overlay');
            const activeIds = Object.keys(currentConfig.db);
            const allElements = svgElement.querySelectorAll('g, path');
            let tooltipTimeline = null;

            // [NEW] ëœë¤ìœ¼ë¡œ ëª‡ ê°œì˜ í¼ì¦ì— 'ì‚´ì•„ìˆëŠ”' íš¨ê³¼ ë¶€ì—¬
            const activeElements = [];

            allElements.forEach(element => {
                const rawId = element.id || '';
                const regionId = rawId.trim();
                if (!regionId) return;
                if (!isDetailMode && regionId.endsWith('_st')) return;
                if (isDetailMode && (regionId.startsWith('total_') || regionId.includes('.svg'))) return;
                if (regionId.toLowerCase().includes('lm')) { element.classList.add('landmark-piece'); return; }

                if (activeIds.includes(regionId)) {
                    element.classList.add('puzzle-piece');
                    activeElements.push(element); // í™œë™ ìš”ì†Œ ìˆ˜ì§‘

                    // [MOBILE UX START] ëª¨ë°”ì¼/ë°ìŠ¤í¬íƒ‘ ë¶„ê¸°
                    const isMobile = window.innerWidth <= 768;

                    if (isMobile) {
                        // 1. ëª¨ë°”ì¼: í„°ì¹˜(Click) ì‹œ ë°”í…€ ì‹œíŠ¸ ì˜¤í”ˆ
                        element.addEventListener('click', function (e) {
                            e.stopPropagation(); // ë°°ê²½ í´ë¦­ê³¼ êµ¬ë¶„

                            // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                            const data = currentConfig.db[regionId] || { name: 'Unknown', count: 0 };
                            const nationalNum = data.national || 0;
                            const localNum = data.local || 0;

                            // ì‹œíŠ¸ ë‚´ìš© ì±„ìš°ê¸°
                            document.getElementById('sheet-title').innerText = data.name;
                            document.getElementById('sheet-count').innerText = data.count.toLocaleString();
                            document.getElementById('sheet-desc').innerText = `ì „êµ­ ${nationalNum.toLocaleString()} + ì§€ì—­ ${localNum.toLocaleString()}`;

                            // ì‹œíŠ¸ í™œì„±í™” & ì§€ë„ ë°€ì–´ì˜¬ë¦¬ê¸°
                            const sheet = document.getElementById('mobile-bottom-sheet');
                            const mapContainer = document.getElementById('svg-container');
                            const introHeader = document.getElementById('intro-header'); // [NEW]

                            sheet.classList.add('active');
                            mapContainer.classList.add('map-shifted');
                            if (introHeader) introHeader.classList.add('header-hidden'); // [NEW]

                            // ë²„íŠ¼ ì•¡ì…˜ ì—°ê²°
                            const btnAction = document.getElementById('btn-sheet-action');
                            btnAction.onclick = () => {
                                const hasDetailMap = REGION_DATA.hasOwnProperty(regionId);
                                const targetUrl = `main.html?region=${regionId}&anim=1`;
                                if (!isDetailMode && hasDetailMap) {
                                    performTransition(() => { window.location.search = `?region=${regionId}`; });
                                } else {
                                    if (localStorage.getItem('isLoggedIn') === 'true') {
                                        performTransition(() => { window.location.href = targetUrl; });
                                    } else {
                                        if (window.openAuthModal) {
                                            window.openAuthModal('promo', data.name, data.count, () => {
                                                performTransition(() => { window.location.href = targetUrl; });
                                            });
                                        } else {
                                            performTransition(() => { window.location.href = targetUrl; });
                                        }
                                    }
                                }
                            };
                        });
                    }

                    // 2. ë°ìŠ¤í¬íƒ‘: ê¸°ì¡´ ë¡œì§
                    if (!isMobile) {
                        // íˆ´íŒ ì´ë²¤íŠ¸
                        element.addEventListener('mouseenter', function () {
                            if (this.tagName.toLowerCase() === 'path' || this.tagName.toLowerCase() === 'g') this.parentNode.appendChild(this);
                            const data = currentConfig.db[regionId] || { name: 'Unknown', count: 0 };
                            // í˜¸ë²„ ì‹œ ì‚´ì•„ìˆëŠ” íš¨ê³¼ ì ì‹œ ì¤‘ë‹¨ (ê¹”ë”í•œ í˜¸ë²„ë¥¼ ìœ„í•´)
                            this.style.animation = 'none';

                            tTitle.innerText = data.name;
                            // [NEW] íˆ´íŒ ë‚´ìš© ìƒì„¸í™” (ì „êµ­ + ì§€ì—­)
                            const nationalNum = data.national || 0;
                            const localNum = data.local || 0;
                            tCountSpan.innerHTML = `
                             <span style="font-size:1.2em;">${data.count.toLocaleString()}</span>
                             <div style="font-size:0.75em; color:#9CA3AF; margin-top:4px; font-weight:500;">
                                 ì „êµ­ ${nationalNum.toLocaleString()} + ì§€ì—­ ${localNum.toLocaleString()}
                             </div>
                        `;
                            tooltip.style.display = 'flex';
                            const rect = element.getBoundingClientRect();
                            const isLeft = (!isDetailMode) ? (currentConfig.leftSideIds || []).includes(regionId) : (rect.left + rect.width / 2) < (window.innerWidth / 2);
                            // [NEW] í•˜ë‹¨ í´ë¦¬í•‘ ë°©ì§€ ë¡œì§
                            // í™”ë©´ í•˜ë‹¨ ì¼ì • ì˜ì—­(ì„¤ì •ê°’ ì°¸ì¡°)ì— ìˆëŠ” ìš”ì†Œë¼ë©´, íˆ´íŒì„ ìš”ì†Œì˜ ìœ„ìª½ìœ¼ë¡œ ë„ì›ë‹ˆë‹¤.
                            const isBottom = (rect.top + rect.height) > (window.innerHeight * TOOLTIP_CONFIG.BOTTOM_THRESHOLD);

                            const tLine = tooltip.querySelector('.tooltip-line'); const tContent = tooltip.querySelector('.tooltip-content');

                            // Yì¶• ìœ„ì¹˜ ê³„ì‚° (ê¸°ë³¸: Top ì •ë ¬ / í•˜ë‹¨ìš”ì†Œ: Bottom ì •ë ¬)
                            let topPos, bottomPos;
                            if (isBottom) {
                                // ìš”ì†Œ ìœ„ë¡œ ë„ìš°ê¸°
                                tooltip.style.top = 'auto';
                                tooltip.style.bottom = `${window.innerHeight - rect.top + TOOLTIP_CONFIG.BOTTOM_ELEVATION_Y}px`;
                                // [UX] ìœ„ë¡œ ëœ° ë•ŒëŠ” ì—°ê²° ì„ (Line)ì„ íˆ´íŒ ë°•ìŠ¤ í•˜ë‹¨ì— ë§ì¶°ì„œ ìš”ì†Œì™€ ê°€ê¹ê²Œ ë°°ì¹˜
                                tooltip.style.alignItems = 'flex-end';
                            } else {
                                // ê¸°ë³¸: ìš”ì†Œ ìƒë‹¨ N% ì§€ì ì— ë§ì¶¤
                                tooltip.style.bottom = 'auto';
                                tooltip.style.top = `${rect.top + rect.height * TOOLTIP_CONFIG.OFFSET_TOP_FACTOR}px`;
                                // ê¸°ë³¸ ì •ë ¬: ì¤‘ì•™
                                tooltip.style.alignItems = 'center';
                            }

                            if (isLeft) {
                                tooltip.style.flexDirection = 'row-reverse';
                                tLine.style.marginRight = '0px'; tLine.style.marginLeft = `${TOOLTIP_CONFIG.LINE_MARGIN_X}px`; tLine.style.transformOrigin = 'right center';
                                tContent.style.alignItems = 'flex-end';
                                tooltip.style.left = 'auto';
                                tooltip.style.right = `${window.innerWidth - (rect.left + rect.width * 0.2)}px`;
                                // Yì¶•ì€ ìœ„ì—ì„œ ê³„ì‚°í•œ top/bottom ì‚¬ìš© (topPos ë³€ìˆ˜ ëŒ€ì‹  ì§ì ‘ style ì§€ì •í–ˆìœ¼ë¯€ë¡œ ìƒëµ)
                            } else {
                                tooltip.style.flexDirection = 'row';
                                tLine.style.marginRight = `${TOOLTIP_CONFIG.LINE_MARGIN_X}px`; tLine.style.marginLeft = '0px'; tLine.style.transformOrigin = 'left center';
                                tContent.style.alignItems = 'flex-start';
                                tooltip.style.right = 'auto';
                                tooltip.style.left = `${rect.right - rect.width * 0.2}px`;
                            }
                            if (tooltipTimeline) tooltipTimeline.kill();
                            tooltipTimeline = gsap.timeline();
                            // [Config] ìœ„ì¹˜ì— ë”°ë¼ ì„  ê¸¸ì´ ë‹¤ë¥´ê²Œ ì ìš©
                            const targetLineLength = isBottom ? TOOLTIP_CONFIG.LINE_LENGTH_BOTTOM : TOOLTIP_CONFIG.LINE_LENGTH_DEFAULT;

                            tooltipTimeline.set(tLine, { width: 0 }).set(tContent, { opacity: 0, y: 10 }).to(tLine, { width: targetLineLength, duration: 0.4, ease: "power2.out" }).to(tContent, { opacity: 1, y: 0, duration: 0.4, ease: "back.out(1.7)" }, "-=0.2");
                        });

                        element.addEventListener('mouseleave', function () {
                            // ì• ë‹ˆë©”ì´ì…˜ ë³µêµ¬ (í´ë˜ìŠ¤ ì¬ì ìš© í•„ìš” ì‹œ)
                            this.style.animation = '';
                            if (tooltipTimeline) tooltipTimeline.kill(); tooltip.style.display = 'none';
                        });

                        // í´ë¦­ ì´ë²¤íŠ¸
                        element.addEventListener('click', (e) => {
                            e.stopPropagation(); tooltip.style.display = 'none';
                            const data = currentConfig.db[regionId];
                            const hasDetailMap = REGION_DATA.hasOwnProperty(regionId);
                            const targetUrl = `main.html?region=${regionId}&anim=1`;

                            if (!isDetailMode && hasDetailMap) {
                                performTransition(() => { window.location.search = `?region=${regionId}`; });
                                return;
                            }
                            console.log("í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœ:", isLoggedIn); // <--- ì´ ì¤„ì„ ì¶”ê°€!
                            if (localStorage.getItem('isLoggedIn') === 'true') {
                                performTransition(() => { window.location.href = targetUrl; });
                            } else {
                                if (window.openAuthModal) {
                                    window.openAuthModal('promo', data.name, data.count, () => {
                                        performTransition(() => { window.location.href = targetUrl; });
                                    });
                                } else {
                                    performTransition(() => { window.location.href = targetUrl; });
                                }
                            }
                        });
                    }
                } else { element.classList.add('region-disabled'); }
            });

            // [NEW] ëœë¤ìœ¼ë¡œ 3ê°œ ì •ë„ì˜ ì§€ì—­ì— í˜¸í¡ íš¨ê³¼ ë¶€ì—¬
            if (activeElements.length > 0) {
                // ì„ê¸°
                const shuffled = activeElements.sort(() => 0.5 - Math.random());
                // ìƒìœ„ 3ê°œ í˜¹ì€ ì „ì²´ì˜ 30%
                const selected = shuffled.slice(0, Math.max(2, Math.floor(activeElements.length * 0.3)));
                selected.forEach(el => el.classList.add('region-alive'));
            }

            function performTransition(callback) {
                gsap.timeline().to("#svg-container", { scale: 5, opacity: 0, duration: 0.8, ease: "power4.in" }).to(overlay, { opacity: 1, duration: 0.5 }, "<0.3").to({}, { onComplete: callback });
            }

            // [MOBILE UX] ë°”í…€ ì‹œíŠ¸ ë‹«ê¸° ì´ë²¤íŠ¸ (ì „ì—­)
            const closeBottomSheet = () => {
                const sheet = document.getElementById('mobile-bottom-sheet');
                const mapContainer = document.getElementById('svg-container');
                const introHeader = document.getElementById('intro-header'); // [NEW]

                if (sheet) sheet.classList.remove('active');
                if (mapContainer) mapContainer.classList.remove('map-shifted');
                if (introHeader) introHeader.classList.remove('header-hidden'); // [NEW]
            };

            const btnSheetClose = document.getElementById('btn-sheet-close');
            if (btnSheetClose) btnSheetClose.addEventListener('click', (e) => {
                e.stopPropagation();
                closeBottomSheet();
            });

            // ì§€ë„ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
            svgElement.addEventListener('click', (e) => {
                // í¼ì¦ ì¡°ê°(stopPropagationë¨)ì´ ì•„ë‹Œ ë°°ê²½ í´ë¦­ ì‹œ
                closeBottomSheet();
            });
        }


        // [2] DB ë§¤í•‘ ì •ë³´ (API ì—°ê²°ìš©)
        const DB_MAPPING = {
            'ì„œìš¸': { group: 'metropolitan', key: 'detail_seoul' },
            'ê²½ê¸°': { group: 'metropolitan', key: 'detail_gyeonggi' },
            'ì¸ì²œ': { group: 'metropolitan', key: 'detail_incheon' },
            'ì¶©ë‚¨': { group: 'chungnam', key: 'detail_chungnam' },
            'ëŒ€ì „': { group: 'chungnam', key: 'detail_daejun' },
            'ì„¸ì¢…': { group: 'chungnam', key: 'detail_saejong' },
            'ì¶©ë¶': { group: 'national', key: 'chungbug' },
            'ì „ë‚¨': { group: 'jeonnam', key: 'detail_jeonnam' },
            'ê´‘ì£¼': { group: 'jeonnam', key: 'detail_gwangju' },
            'ì „ë¶': { group: 'national', key: 'jeonbug' },
            'ê²½ë¶': { group: 'gyeongbug', key: 'detail_gyeongbug' },
            'ëŒ€êµ¬': { group: 'gyeongbug', key: 'detail_daegu' },
            'ê²½ë‚¨': { group: 'gyeongnam', key: 'detail_gyeongnam' },
            'ë¶€ì‚°': { group: 'gyeongnam', key: 'detail_busan' },
            'ìš¸ì‚°': { group: 'gyeongnam', key: 'detail_ulsan' },
            'ê°•ì›': { group: 'national', key: 'gangwon' },
            'ì œì£¼': { group: 'national', key: 'jeju' }
        };

        // [3] API ë°ì´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        // [3] API ë°ì´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        async function updateMapData() {
            try {
                const response = await fetch('/api/landing/stats');
                const dbCounts = await response.json();

                // [NEW] ì „êµ­ ë°ì´í„° ì¶”ì¶œ (ì—†ìœ¼ë©´ 0)
                const nationalCount = Number(dbCounts['ì „êµ­'] || 0);

                for (const [koreanName, count] of Object.entries(dbCounts)) {
                    const mapInfo = DB_MAPPING[koreanName];
                    if (mapInfo) {
                        // [NEW] í•´ë‹¹ ì§€ì—­ ìˆ˜ëŸ‰ + ì „êµ­ ìˆ˜ëŸ‰ í•©ì‚°
                        const totalCount = Number(count) + nationalCount;

                        if (REGION_DATA[mapInfo.group] && REGION_DATA[mapInfo.group].db[mapInfo.key]) {
                            const target = REGION_DATA[mapInfo.group].db[mapInfo.key];
                            target.count = totalCount;
                            target.local = Number(count);       // ì§€ì—­ ì „ìš©
                            target.national = nationalCount;    // ì „êµ­ ê³µí†µ
                        }
                        if (mapInfo.group === 'national' && REGION_DATA['national'].db[mapInfo.key]) {
                            const target = REGION_DATA['national'].db[mapInfo.key];
                            target.count = totalCount;
                            target.local = Number(count);
                            target.national = nationalCount;
                        }
                    }
                }
                calculateGroupTotals();
            } catch (e) {
                console.error("DB ë¡œë“œ ì‹¤íŒ¨ (ê¸°ë³¸ê°’ ì‚¬ìš©):", e);
            }
        }

        // [4] ê·¸ë£¹ í•©ê³„ ì¬ê³„ì‚°
        function calculateGroupTotals() {
            const groups = ['metropolitan', 'chungnam', 'jeonnam', 'gyeongbug', 'gyeongnam'];
            groups.forEach(groupName => {
                const groupDB = REGION_DATA[groupName].db;
                let totalLocal = 0;
                let nationalVal = 0;

                Object.values(groupDB).forEach(item => {
                    totalLocal += (item.local || 0);
                    // í•˜ë‚˜ë¼ë„ national ê°’ì´ ìˆìœ¼ë©´ ê°€ì ¸ì˜´ (ì–´ì°¨í”¼ ë™ì¼)
                    if (item.national) nationalVal = item.national;
                });

                if (REGION_DATA['national'].db[groupName]) {
                    const target = REGION_DATA['national'].db[groupName];
                    const numChildren = Object.keys(groupDB).length;

                    // ê·¸ë£¹ì˜ Total Count = (ì§€ì—­ í•©ê³„) + (ì „êµ­ * ìì‹ ì§€ì—­ ìˆ˜) ê°€ ì•„ë‹ˆë¼!
                    // í™”ë©´ì— ë³´ì—¬ì¤„ ë• "ì´ ê·¸ë£¹ì— ì†í•œ ì§€ì—­ë“¤ì˜ ì´ í˜œíƒ ìˆ˜"ì´ë¯€ë¡œ
                    // ë‹¨ìˆœíˆ ì§€ì—­ í•©ê³„ + ì „êµ­ 1íšŒ? ì•„ë‹ˆë©´ ê° ì§€ì—­ í˜œíƒì˜ í•©?
                    // "ì„œìš¸(688) + ê²½ê¸°(500) + ..." -> ìˆ˜ë„ê¶Œ í´ë¦­ ì‹œ ì´ë“¤ì„ ë‹¤ ë³´ì—¬ì¤Œ.
                    // ë”°ë¼ì„œ ê¸°ì¡´ ë¡œì§ëŒ€ë¡œ ê° ì§€ì—­ Totalì˜ í•©ì„ ìœ ì§€í•˜ë˜,
                    // íˆ´íŒ í‘œê¸°ìš© local/nationalì„ ë¶„ë¦¬ ì €ì¥

                    target.local = totalLocal;

                    // ğŸš¨ ì£¼ì˜: 'ì „êµ­' ìˆ˜ëŸ‰ì€ ì—¬ê¸°ì„œ í•©ì‚°í•˜ì§€ ì•Šê³  ë‹¨ì¼ ê°’ìœ¼ë¡œ ë³´ì—¬ì¤„ì§€,
                    // ì•„ë‹ˆë©´ ê° ì§€ì—­ë³„ ì¤‘ë³µì„ í¬í•¨í• ì§€ ê²°ì •í•´ì•¼ í•¨.
                    // í˜„ì¬ UIìƒ "ì„œìš¸ 688"ì€ "ì„œìš¸ì§€ì—­ + ì „êµ­"ì„.
                    // ìˆ˜ë„ê¶Œ ì „ì²´ í˜œíƒ ìˆ˜ëŠ” (ì„œìš¸+ì „êµ­) + (ê²½ê¸°+ì „êµ­) ... ìœ¼ë¡œ ê³„ì‚°ë˜ì–´ ìˆìŒ (ê¸°ì¡´ total ë¡œì§).
                    // ë”°ë¼ì„œ breakdownë„ ì´ì— ë§ì¶°ì•¼ í•¨.
                    // National part of group = National * numChildren

                    target.national = nationalVal * numChildren;

                    // ë§Œì•½ totalì„ ë‹¤ì‹œ ê³„ì‚°í•˜ê³  ì‹¶ë‹¤ë©´:
                    target.count = target.local + target.national;
                }
            });
        }

        // [5] í†µí•© ì‹¤í–‰ ë¡œì§ (í•µì‹¬)
        document.addEventListener("DOMContentLoaded", async () => {
            // Step 1: DB ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°)
            await updateMapData();

            // Step 2: í™”ë©´ UI ì´ˆê¸°í™”
            const mainContent = document.getElementById('main-content');
            const introGate = document.getElementById('intro-gate');
            const introContent = document.getElementById('intro-content');
            const btnStart = document.getElementById('btn-start');
            const backNav = document.getElementById('back-nav');
            const headerTitle = document.getElementById('header-title');
            const headerDesc = document.getElementById('header-desc');
            const userStatus = document.getElementById('user-status'); // [NEW]
            const userNameDisplay = document.getElementById('user-name-display'); // [NEW]

            if (currentRegionKey === 'national') {
                headerTitle.innerHTML = `ì“±-ì“± í›‘ì–´ ë³´ëŠ”<br>ì²­ë…„ ì •ì±… ì†Œì‹`;
            } else {
                headerTitle.innerText = `Sseuk-Sseuk : ${currentConfig.title}`;
            }
            headerDesc.innerText = currentConfig.desc;
            const hasVisited = sessionStorage.getItem('sseuk_intro_visited');

            // [NEW] ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° í‘œì‹œ
            const savedUserName = localStorage.getItem('userName');
            if (isLoggedIn && savedUserName) {
                if (userStatus && userNameDisplay) {
                    userNameDisplay.innerText = savedUserName;
                    userStatus.classList.remove('hidden');

                    // [Inline] ë¡œê·¸ì•„ì›ƒ ë¡œì§ ì—°ê²°
                    const logoutBtn = document.getElementById('btn-landing-logout');
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', (e) => {
                            e.stopPropagation(); // ë²„ë¸”ë§ ë°©ì§€
                            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                localStorage.removeItem('isLoggedIn');
                                localStorage.removeItem('userName');
                                localStorage.removeItem('userEmail');
                                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                                window.location.reload();
                            }
                        });
                    }
                }
                // ë¡œê·¸ì¸ ìƒíƒœë©´ intro gateì—ì„œë„ ë¡œê·¸ì¸ ë²„íŠ¼ ìˆ¨ê¸°ê¸° (ì„ íƒì‚¬í•­)
                const introLoginBtn = document.getElementById('btn-intro-login');
                if (introLoginBtn) introLoginBtn.style.display = 'none';
            }

            if (isDetailMode || hasVisited || isLoggedIn) {
                introGate.classList.add('hidden');
                if (isDetailMode) backNav.classList.remove('hidden');
                mainContent.classList.remove('hidden'); mainContent.style.opacity = 1;
            } else {
                introGate.classList.remove('hidden'); introGate.classList.add('flex');
                gsap.to(introContent, { opacity: 1, y: 0, duration: 0.8, ease: "back.out(1.7)", delay: 0.2 });
                btnStart.addEventListener('click', () => {
                    sessionStorage.setItem('sseuk_intro_visited', 'true');
                    gsap.to(introGate, { opacity: 0, duration: 0.8, ease: "power2.inOut", onComplete: () => { introGate.style.display = 'none'; } });
                });
            }

            // Step 3: ì§€ë„ SVG ë¡œë“œ ë° ê·¸ë¦¬ê¸° (ë°ì´í„°ëŠ” ì´ë¯¸ Step 1ì—ì„œ ìµœì‹ í™”ë¨)
            fetch(currentConfig.mapPath)
                .then(res => { if (!res.ok) throw new Error("Map file error"); return res.text(); })
                .then(text => {
                    document.getElementById('svg-container').innerHTML = text;
                    initMapEvents();
                    if (!introGate.classList.contains('hidden')) {
                        mainContent.classList.remove('hidden');
                        gsap.to(mainContent, { opacity: 1, duration: 0.5 });
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('svg-container').innerHTML = "<p class='text-red-500'>ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
                });
        });
    </script>
    <!-- [MOBILE UX START] ë°”í…€ ì‹œíŠ¸ HTML -->
    <div id="mobile-bottom-sheet">
        <div class="flex justify-between items-start">
            <h2 id="sheet-title" class="text-2xl font-extrabold text-gray-900">ì§€ì—­ëª…</h2>
            <button id="btn-sheet-close" class="p-2 -mr-2 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="flex flex-col gap-1">
            <span id="sheet-count" class="text-4xl font-bold text-[#4A9EA8]">0</span>
            <span id="sheet-desc" class="text-sm text-gray-500 font-medium">ì „êµ­ 0 + ì§€ì—­ 0</span>
        </div>
        <button id="btn-sheet-action"
            class="w-full py-4 bg-[#4A9EA8] hover:bg-[#3b858e] text-white font-bold rounded-xl text-lg mt-2 transition-colors">
            ì´ ì§€ì—­ ìì„¸íˆ ë³´ê¸°
        </button>
    </div>
    <!-- [MOBILE UX END] -->

</body>

</html>
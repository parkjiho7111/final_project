


지역별 스와이프 카드 필터링 구현


수정파일
main_page.py 변경됨

목표
랜딩페이지에서 선택한 지역에 따라 메인페이지의 스와이프 카드에 해당 지역 + 전국 정책만 표시되도록 수정

현재 상황
랜딩페이지에서 지역 선택 시 main.html?region=detail_seoul 형태로 URL 파라미터 전달
메인페이지 백엔드(routers/main_page.py)에서는 지역 정보를 받지 않고 전체 정책에서 랜덤 추출
카테고리별 3개씩 총 18개 정책을 랜덤 셔플하여 표시
구현 계획
1. 지역 ID → DB 지역명 변환 함수 추가
파일: routers/main_page.py랜딩페이지에서 사용하는 지역 ID(detail_seoul, detail_chungnam 등)를 DB에 저장된 지역명(서울, 충남 등)으로 변환하는 함수 추가:

def convert_region_id_to_db_name(region_id: str) -> str:
    """
    랜딩페이지 지역 ID를 DB 지역명으로 변환
    예: 'detail_seoul' -> '서울', 'detail_chungnam' -> '충남'
    """
    region_id_to_db_name = {
        'detail_seoul': '서울',
        'detail_incheon': '인천',
        'detail_gyeonggi': '경기',
        'detail_daejun': '대전',
        'detail_saejong': '세종',
        'detail_chungnam': '충남',
        'detail_gwangju': '광주',
        'detail_jeonnam': '전남',
        'detail_daegu': '대구',
        'detail_gyeongbug': '경북',
        'detail_busan': '부산',
        'detail_ulsan': '울산',
        'detail_gyeongnam': '경남',
        'gangwon': '강원',
        'chungbug': '충북',
        'jeonbug': '전북',
        'jeju': '제주'
    }
    return region_id_to_db_name.get(region_id, None)


2. read_main 함수 수정
파일: routers/main_page.py

region 쿼리 파라미터 추가
지역 필터링 로직 추가: 선택한 지역 + 전국 정책만 필터링
카테고리별 3개씩 추출 시 지역 필터 적용
@router.get("/main.html")
async def read_main(
    request: Request, 
    region: Optional[str] = None,  # URL 파라미터 추가
    db: Session = Depends(get_db)
):
    target_categories = ["취업", "창업", "주거", "금융", "교육", "복지"]
    all_picks = []
    
    # 지역 필터 설정
    filter_regions = ['전국']  # 기본값: 전국만
    if region:
        db_region_name = convert_region_id_to_db_name(region)
        if db_region_name:
            filter_regions = [db_region_name, '전국']  # 선택 지역 + 전국
    
    # 1. 카테고리별 랜덤 추출 (지역 필터 적용)
    for cat in target_categories:
        policies = db.query(Policy)\
            .filter(Policy.genre.contains(cat))\
            .filter(Policy.region.in_(filter_regions))  # 지역 필터 추가
            .order_by(func.random())\
            .limit(3)\
            .all()
        all_picks.extend(policies)
    
    # 2. 섞기
    random.shuffle(all_picks)
    
    # 3. 슬라이드용 데이터 (기존 로직 유지 또는 지역 필터 적용 선택)
    slider_policies = db.query(Policy)\
        .order_by(func.random())\
        .limit(20)\
        .all()
    
    # 직렬화 및 템플릿 렌더링
    tinder_data_list = [serialize_policy(p) for p in all_picks]
    slider_data_list = [serialize_policy(p) for p in slider_policies]
    
    return templates.TemplateResponse("main.html", {
        "request": request,
        "tinder_data_list": tinder_data_list,
        "slider_data_list": slider_data_list
    })

    slider_policies = db.query(Policy)\
    .filter(Policy.region.in_(filter_regions)) \
    .order_by(func.random())\
    .limit(20)\
    .all()




3. Optional import 추가
파일: routers/main_page.pyOptional 타입 힌트를 위해 import 추가:

from typing import Optional


데이터 흐름
URL 파라미터region=detail_seoul
convert_region_id_to_db_name
필터 조건
카테고리별 3개씩
랜덤 셔플
직렬화
랜딩페이지지역 선택
메인페이지read_main 함수
지역 ID 변환detail_seoul → 서울
DB 쿼리region IN 서울, 전국
6개 카테고리총 18개 정책
최종 정책 리스트
스와이프 카드렌더링


예상 결과
서울 선택 시
DB 쿼리: region IN ('서울', '전국')
서울 정책 30건 + 전국 정책 191건 중에서
카테고리별 3개씩 추출 (총 18개)
랜덤 셔플하여 표시
충남 선택 시
DB 쿼리: region IN ('충남', '전국')
충남 정책 + 전국 정책 중에서
카테고리별 3개씩 추출 (총 18개)
랜덤 셔플하여 표시
테스트 시나리오
랜딩페이지에서 서울 선택 → 메인페이지 이동
URL: main.html?region=detail_seoul
스와이프 카드에 서울 + 전국 정책만 표시
랜딩페이지에서 충남 선택 → 메인페이지 이동
URL: main.html?region=detail_chungnam

수정파일
main_page.py 변경됨